#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Running pre-push checks..."

# Prevent pushing to main branch
branch=$(git rev-parse --abbrev-ref HEAD)
if [ "$branch" = "main" ]; then
  echo "âŒ Direct pushes to main branch are not allowed"
  echo "ğŸ’¡ Use: git push origin feature/your-branch"
  exit 1
fi

# TypeScript type checking via Next.js build
echo "ğŸ“ Checking TypeScript types..."
npm run type-check
if [ $? -ne 0 ]; then
  echo "âŒ TypeScript type check failed"
  exit 1
fi

# Build verification (already done by type-check)
echo "ğŸ—ï¸  Build verification completed"

# Dependency check
echo "ğŸ“¦ Checking dependencies..."
npm ci --dry-run
if [ $? -ne 0 ]; then
  echo "âŒ Dependencies are out of sync"
  echo "ğŸ’¡ Run: npm install"
  exit 1
fi

# Run tests
echo "ğŸ§ª Running tests..."
npm run test:ci
if [ $? -ne 0 ]; then
  echo "âŒ Tests failed"
  exit 1
fi

echo "âœ… Pre-push checks passed!"